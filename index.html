<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Make the World your Workplace - Webnomad</title>
    <meta name="description" content="Find a internet cafe hotspot where to work next to where you are. Contribute to the open map of the best internet work places.">

    <script src="bower_components/ddp.js/src/ddp.js"></script>
    <script src="bower_components/q/q.js"></script>
    <script src="bower_components/asteroid/dist/asteroid.browser.js"></script>
    <!-- <script src="js/routes.js"></script> -->

    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="stylesheet" href="./css/main.css" charset="utf-8">
    <link rel="stylesheet" href="./css/large.css" media="(min-width: 800px)">

    <link rel="import" href="./bower_components/iron-form/iron-form.html">
    <link rel="import" href="./bower_components/leaflet-map/leaflet-map.html">
    <link rel="import" href="./bower_components/iron-icons/iron-icons.html">
    <link rel="import" href="./bower_components/paper-dialog/paper-dialog.html">
    <link rel="import" href="./bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
    <link rel="import" href="./bower_components/paper-button/paper-button.html">
    <link rel="import" href="./bower_components/paper-icon-button/paper-icon-button.html">
    <link rel="import" href="./bower_components/paper-toast/paper-toast.html">
  </head>

  <body>
    <template id="app" is="dom-bind">
      <leaflet-map max-zoom=18 fit-to-markers>
        <template is="dom-repeat" items="[[spots]]">
          <leaflet-marker longitude="[[item.position.longitude]]" latitude="[[item.position.latitude]]" title="[[item.name]]">
            <h1>[[item.name]]</h1>
          </leaflet-marker>
        </template>

        <leaflet-geolocation enable-high-accuracy latitude="{{latitude}}" longitude="{{longitude}}" accuracy="{{accuracy}}" watch="true"></leaflet-geolocation>
        <template is="dom-if" if="[[latitude]]">
          <leaflet-marker latitude="[[latitude]]" longitude="[[longitude]]" id="user-marker" title="This is you">This is you</leaflet-marker>
          <leaflet-circle latitude="[[latitude]]" longitude="[[longitude]]" radius="[[accuracy]]" color="#d00"></leaflet-circle>
        </template>
    </leaflet-map>

    <paper-icon-button icon="icons:add" id="add-spot" title="Contribute">+</paper-icon-button>

    <paper-dialog id="create-form" modal center>
      <h2>Add your workplace</h2>
      <paper-dialog-scrollable>
        <form method=post>
          <input type="hidden" name="latitude" value="[[latitude]]">
          <input type="hidden" name="longitude" value="[[longitude]]">

          <div class="control required">
            <label for="name">Name</label>
            <input type=text name="name" required>
          </div>
          <div>
            <label for="wifi">WiFi Quality</label>
            <input type=range name="wifi" min=0 max=5 value=3 id="wifi">
          </div>
          <div>
              <input name="power" type="checkbox" id="power-available">
              <label for="power-available">Power is available</label>
          </div>
          <div>
            <label for="name">Type of place</label>
            <select name="type" required>
              <option value="coworking">Coworking space</option>
              <option value="coffeeshop">Coffeeshop / Restaurant</option>
              <option value="other">Library / Museum / other</option>
            </select>
          </div>
          <div>
            <label for="name">Anything to say?</label>
            <textarea name="comment"></textarea>
          </div>
          <div>
            <label for="name">Your nickname</label>
            <input type=text name="author">
          </div>
          <div class="buttons">
            <paper-button dialog-dismiss class="clear">Cancel</paper-button>
            <paper-button class="save">Save</paper-button>
          </div>
        </form>
      </paper-dialog-scrollable>
    </paper-dialog>
    <paper-toast></paper-toast>
  </body>

  <script>
    window.addEventListener('WebComponentsReady', function(e) {

      var app = document.querySelector('#app')
      var alert = document.querySelector('paper-toast')

      // Load spots
      var remote = new Asteroid("api.webnomad.org")
      var SpotsCollection = remote.getCollection('spots')
      var spotsSub = remote.subscribe('SpotsAll')
      var spots = SpotsCollection.reactiveQuery({})
      spots.on('change', function() {
        app.spots = spots.result
      })

      // Locate user
      function localizeUser(evt) {
        evt.target.removeEventListener(evt.type, arguments.callee)
        var lmap = document.querySelector('leaflet-map')
        var location = evt.detail
        // hack to next tick
        setTimeout(function() {
          lmap.latitude = location.latitude
          lmap.longitude = location.longitude
          lmap.zoom = 16
          var userMarker = document.querySelector('#user-marker')
          userMarker.icon = L.icon({
              "iconUrl": "images/position.png",
              "iconSize": L.point(26, 25),
              "iconAnchor": L.point(13, 13)
          });
        }, 10)
      }
      var geolocation = document.querySelector('leaflet-geolocation')
      geolocation.addEventListener('locationfound', localizeUser)

      // May serve soon
      app.addEventListener('dom-change', function() {});

      // Form popup
      var createFormModal = document.querySelector('#create-form')
      var createForm = createFormModal.querySelector('form')
      document.querySelector('#add-spot').addEventListener('tap', function() {
        createFormModal.open()
      })

      // Click save close modal
      createFormModal.querySelector('.save').addEventListener('click', function(e) {
        if(!app.latitude) {
          alert.text = "You must be localized to Contribute"
          alert.className = 'error'
          alert.open()
        }
        else if(!createForm.checkValidity()) {
          alert.text = "Please check your values"
          alert.classList = ['error']
          alert.open()
        }
        else {
          createForm.submit()
          createFormModal.close()
        }
      })

      // Click save submits form
      createForm.submit = function() {
        debugger
        var data = {};
        [].forEach.call(e.target.querySelectorAll('[name]'), function(input) {
          data[input.attributes['name'].value] = input.value
        });
        SpotsCollection.insert({
          name: data.name,
          wifiQuality: data.wifi,
          powerAvailable: data.power,
          comments: [data.comment],
          position: {latitude: data.latitude, longitude: data.longitude},
        })
        alert.text = `${data.name} was added to the work spots!`
        alert.classList = ['success']
        alert.show()
        return false
      }
    })

  </script>
</html>
