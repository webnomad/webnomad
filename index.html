<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Make the World your Workplace - Webnomad</title>
    <meta name="description" content="Find a internet cafe hotspot where to work next to where you are. Contribute to the open map of the best internet work places.">

    <script src="//cdn.rawgit.com/feathersjs/feathers-client/v1.0.0/dist/feathers.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.4.5/socket.io.min.js"></script>
    <!-- <script src="js/routes.js"></script> -->

    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="stylesheet" href="./css/main.css" charset="utf-8">
    <link rel="stylesheet" href="./css/large.css" media="(min-width: 800px)">

    <link rel="import" href="./bower_components/paper-toast/paper-toast.html">
    <link rel="import" href="./elements/app-map.html">
    <link rel="import" href="./elements/spot-editor.html">
  </head>

  <body>
    <app-map></app-map>
    <spot-editor latitude="[[latitude]]" longitude="[[longitude]]"></spot-editor>
    <paper-toast></paper-toast>
<script type="text/javascript">
  var _paq=_paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="//piwik-vinyll.rhcloud.com/";_paq.push(["setTrackerUrl",e+"piwik.php"]),_paq.push(["setSiteId",1]);var a=document,p=a.createElement("script"),r=a.getElementsByTagName("script")[0];p.type="text/javascript",p.async=!0,p.defer=!0,p.src=e+"piwik.js",r.parentNode.insertBefore(p,r)}();
</script>
<noscript><p><img src="//piwik-vinyll.rhcloud.com/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
  </body>

  <script>
    var serverURL = location.hash === '#local' ? 'localhost:3030' : '158.58.170.155:3030'

    window.addEventListener('WebComponentsReady', function(e) {
      var map = document.querySelector('app-map')
      var alert = document.querySelector('paper-toast')
      var editor = document.querySelector('spot-editor')
      var user = JSON.parse(localStorage.getItem('user')) || {name: '', location: {}};

      function updateUser(data) {
        Object.keys(data).forEach(function(key) {user[key] = data[key]})
        editor.user = user
        localStorage.setItem('user', JSON.stringify(
          {name: user.name, location: {}}
        ));
      }

      // User
      // Listen for geolocation or name change and update user
      map.addEventListener('location', function(event) {
        updateUser({location: event.detail})
      })
      editor.addEventListener('save', function(event) {
        updateUser({name: event.detail.author})
      })

      // Inject spots into map
      var app = feathers()
      app.configure(feathers.socketio(io(serverURL)))
      var spots = app.service('spots')

      function alertUser(type, message) {
        alert.text = message
        alert.className = type
        alert.show()
      }

      function loadSpots() {
        spots.find().then(function(dbSpots) {
          map.spots = dbSpots
          editor.spots = dbSpots
        })
      }

      // Page load spots
      spots.find().then(function() {
        loadSpots()
      })
      // Created spot, refresh display
      spots.on('created', function() {
        loadSpots()
      });

      editor.addEventListener('invalid', function(event) {
        alertUser('error', event.detail)
      })

      editor.addEventListener('save', function(event) {
        spots.create(event.detail)
        alertUser('success', 'Your work spot was saved!')
      })
    })

  </script>
</html>
