<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Make the World your Workplace - Webnomad</title>
    <meta name="description" content="Find a internet cafe hotspot where to work next to where you are. Contribute to the open map of the best internet work places.">

    <script src="bower_components/ddp.js/src/ddp.js"></script>
    <script src="bower_components/q/q.js"></script>
    <script src="bower_components/asteroid/dist/asteroid.browser.js"></script>
    <!-- <script src="js/routes.js"></script> -->

    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="stylesheet" href="./css/main.css" charset="utf-8">
    <link rel="stylesheet" href="./css/large.css" media="(min-width: 800px)">

    <link rel="import" href="./bower_components/paper-toast/paper-toast.html">
    <link rel="import" href="./elements/app-map.html">
    <link rel="import" href="./elements/spot-editor.html">
  </head>

  <body>
    <app-map></app-map>
    <spot-editor latitude="[[latitude]]" longitude="[[longitude]]"></spot-editor>
    <paper-toast></paper-toast>
  </body>

  <script>
    var serverURL = 'api.webnomad.org'

    window.addEventListener('WebComponentsReady', function(e) {
      var map = document.querySelector('app-map')
      var alert = document.querySelector('paper-toast')
      var editor = document.querySelector('spot-editor')
      var user = JSON.parse(localStorage.getItem('user')) || {name: '', location: {}};

      // User
      // Listen for geolocation and update user
      map.addEventListener('location', function(event) {
        user.location = event.detail
      })

      // When user change update components (user.location >> editor lat/lng)
      Object.observe(user, function(change) {
        editor.user = user
        localStorage.setItem('user', JSON.stringify({name: user.name, location: {}}));
      })

      editor.addEventListener('save', function(event) {
        user.name = event.detail.author
      })

      // Load spots
      var remote = new Asteroid(serverURL)
      var Spots = remote.getCollection('spots')
      var spots = Spots.reactiveQuery({})

      // Inject spots into map
      map.spots = spots.result
      spots.on('change', function() {
        map.spots = spots.result
      })

      // Editor listening
      editor.collection = Spots
      editor.addEventListener('invalid', function(event) {
        alert.text = event.detail
        alert.className = 'error'
        alert.show()
      })
      editor.addEventListener('created', function(event) {
        alert.text = event.detail
        alert.className = 'success'
        alert.show()
      })
    })

  </script>
</html>
