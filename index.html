<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Make the World your Workplace - Webnomad</title>
    <meta name="description" content="Find a internet cafe hotspot where to work next to where you are. Contribute to the open map of the best internet work places.">

    <script src="https://npmcdn.com/kinto@1.2.0/dist/kinto-1.2.0.min.js"></script>
    <!-- <script src="js/routes.js"></script> -->

    <script src="bower_components/webcomponentsjs/webcomponents-lite.min.js"></script>
    <link rel="stylesheet" href="./css/main.css" charset="utf-8">
    <link rel="stylesheet" href="./css/large.css" media="(min-width: 800px)">

    <link rel="import" href="./bower_components/paper-toast/paper-toast.html">
    <link rel="import" href="./elements/app-map.html">
    <link rel="import" href="./elements/spot-editor.html">
  </head>

  <body>
    <app-map></app-map>
    <spot-editor latitude="[[latitude]]" longitude="[[longitude]]"></spot-editor>
    <paper-toast></paper-toast>
<script type="text/javascript">
  var _paq=_paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){var e="//piwik-vinyll.rhcloud.com/";_paq.push(["setTrackerUrl",e+"piwik.php"]),_paq.push(["setSiteId",1]);var a=document,p=a.createElement("script"),r=a.getElementsByTagName("script")[0];p.type="text/javascript",p.async=!0,p.defer=!0,p.src=e+"piwik.js",r.parentNode.insertBefore(p,r)}();
</script>
<noscript><p><img src="//piwik-vinyll.rhcloud.com/piwik.php?idsite=1" style="border:0;" alt="" /></p></noscript>
  </body>

  <script>
    var serverURL = 'https://kinto.dev.mozaws.net/v1'
    var db = new Kinto({
      remote: serverURL,
      headers: {Authorization: 'Basic ' + btoa('webnomad:webnomad')}
    })
    var Spots = db.collection('spots')

    window.addEventListener('WebComponentsReady', function(e) {
      var map = document.querySelector('app-map')
      var alert = document.querySelector('paper-toast')
      var editor = document.querySelector('spot-editor')
      var user = JSON.parse(localStorage.getItem('user')) || {name: '', location: {}};

      function updateUser(data) {
        Object.keys(data).forEach(function(key) {user[key] = data[key]})
        editor.user = user
        localStorage.setItem('user', JSON.stringify(
          {name: user.name, location: {}}
        ));
      }

      // User
      // Listen for geolocation and update user
      map.addEventListener('location', function(event) {
        updateUser({location: event.detail})
      })

      editor.addEventListener('save', function(event) {
        updateUser({name: event.detail.author})
      })

      // Inject spots into map

      // Editor listening
      Spots.sync()
      .then(function() {
        return Spots.list()
      })
      .then(function(spots) {
        map.spots = spots.data
        editor.collection = spots.data
      })
      editor.addEventListener('invalid', function(event) {
        alert.text = event.detail
        alert.className = 'error'
        alert.show()
      })

      editor.addEventListener('save', function(event) {
        console.debug('creating', event.detail)
        Spots.create(event.detail)
        .then(function(res) {
          var author = event.detail.author || 'webnomad'
          return Spots.sync({
            remote: serverURL,
            headers: {Authorization: 'Basic ' + btoa('webnomad' + ':' + 'webnomad')}
          })
        })
        .then(function() {
          alert.className = 'success'
          alert.text = 'Your work spot was saved!'
          alert.show()
        })
        .catch(function(err) {
          console.error(err);
          alert.className = 'error'
          alert.text = 'Please check the form'
          alert.show()
        })
      })

      editor.addEventListener('created', function(event) {
        console.debug('created', event)
        alert.text = event.detail
        alert.className = 'success'
        alert.show()
      })
    })

  </script>
</html>
